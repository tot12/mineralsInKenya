<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/bootstrap/bootstrap-icons.css" rel="stylesheet">
    <style>
       /* path{
            transform: scale(5.0);
            -ms-transform: scale(5.0);
            -webkit-transform: scale(5.0);
        }*/
       #tooltip {
          /* position: absolute;
          /* top: 0;
           left: 0;
          /* border: solid 1px red;)/
           /*padding: 5px;*/
       }
    </style>
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
<svg id="svg1" style="width: 100%;height: 90vh;background-color: beige;z-index: 1;position: fixed"></svg>
<svg id="svg2" style="width: 100%;height: 90vh;background-color:transparent;position: relative;z-index: 2000">
    <path id="mypath" style="fill:none;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;  "
          d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"
/></svg>
<!--<i id="tooltip" style="color: red;width: 2px;height:2px;" class="bi bi-geo-alt-fill"></i>-->
<script>
    var data = {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {
                    "_id": 48,
                    "GEN_ZONE": 202,
                    "ZN_ZONE": "CR",
                    "ZN_HOLDING": "N",
                    "HOLDING_ID": 0,
                    "FRONTAGE": -1,
                    "ZN_AREA": -1,
                    "UNITS": -1,
                    "DENSITY": -1,
                    "COVERAGE": 0,
                    "FSI_TOTAL": 0.5,
                    "PRCNT_COMM": 0.3,
                    "PRCNT_RES": 0.5,
                    "PRCNT_EMMP": 0,
                    "PRCNT_OFFC": -1,
                    "ZN_EXCPTN": "Y",
                    "EXCPTN_NO": 627,
                    "STAND_SET": 3,
                    "ZN_STATUS": 2,
                    "ZN_STRING": "CR 0.5 (c0.3; r0.5) SS3  (x627)",
                    "AREA_UNITS": -1,
                    "ZBL_CHAPT": "40",
                    "ZBL_SECTN": "40.10",
                    "ZBL_EXCPTN": "900.11.10(627)"
                },
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": [
                        [
                            [
                                [
                                    -79.28684612825997,
                                    43.78208667458808
                                ],
                                [
                                    -79.28690094755798,
                                    43.78221795057371
                                ],
                                [
                                    -79.28734347293567,
                                    43.7821222824735
                                ],
                                [
                                    -79.28734704123593,
                                    43.782121524014926
                                ],
                                [
                                    -79.28740897135691,
                                    43.78210811949714
                                ],
                                [
                                    -79.28757716836542,
                                    43.78207175254066
                                ],
                                [
                                    -79.28758649329966,
                                    43.782069735611415
                                ],
                                [
                                    -79.28755959351963,
                                    43.78201077308563
                                ],
                                [
                                    -79.28752574258546,
                                    43.781939574068254
                                ],
                                [
                                    -79.28750849767346,
                                    43.78194331349026
                                ],
                                [
                                    -79.28729220868847,
                                    43.781990230213914
                                ],
                                [
                                    -79.28684612825997,
                                    43.78208667458808
                                ]
                            ]
                        ]
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "_id": 53,
                    "GEN_ZONE": 202,
                    "ZN_ZONE": "CR",
                    "ZN_HOLDING": "N",
                    "HOLDING_ID": 0,
                    "FRONTAGE": -1,
                    "ZN_AREA": -1,
                    "UNITS": -1,
                    "DENSITY": -1,
                    "COVERAGE": 0,
                    "FSI_TOTAL": 2,
                    "PRCNT_COMM": 2,
                    "PRCNT_RES": 1.5,
                    "PRCNT_EMMP": 0,
                    "PRCNT_OFFC": -1,
                    "ZN_EXCPTN": "Y",
                    "EXCPTN_NO": 2473,
                    "STAND_SET": 2,
                    "ZN_STATUS": 2,
                    "ZN_STRING": "CR 2.0 (c2.0; r1.5) SS2  (x2473)",
                    "AREA_UNITS": -1,
                    "ZBL_CHAPT": "40",
                    "ZBL_SECTN": "40.10",
                    "ZBL_EXCPTN": "900.11.10(2473)"
                },
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": [
                        [
                            [
                                [
                                    -79.40286848975248,
                                    43.656552586218766
                                ],
                                [
                                    -79.40308792555656,
                                    43.65650980901202
                                ],
                                [
                                    -79.40341699187374,
                                    43.656445655839626
                                ],
                                [
                                    -79.40342943078532,
                                    43.65644320897961
                                ],
                                [
                                    -79.40347712732354,
                                    43.65643408588737
                                ],
                                [
                                    -79.40345865389567,
                                    43.65638810038722
                                ],
                                [
                                    -79.40342847408668,
                                    43.65631298562346
                                ],
                                [
                                    -79.40342775787326,
                                    43.656311202750864
                                ],
                                [
                                    -79.40341561634739,
                                    43.65631376687959
                                ],
                                [
                                    -79.40338097766082,
                                    43.656321073709364
                                ],
                                [
                                    -79.40336852637475,
                                    43.65632352055371
                                ],
                                [
                                    -79.40333391264568,
                                    43.65633071937408
                                ],
                                [
                                    -79.40327037762718,
                                    43.65634394262331
                                ],
                                [
                                    -79.40324050140914,
                                    43.6563501552754
                                ],
                                [
                                    -79.4032196041714,
                                    43.656354503240706
                                ],
                                [
                                    -79.40316148873386,
                                    43.65636660584862
                                ],
                                [
                                    -79.4031591805937,
                                    43.656360230936635
                                ],
                                [
                                    -79.40314378898825,
                                    43.6563176595079
                                ],
                                [
                                    -79.40312444769363,
                                    43.65626415708908
                                ],
                                [
                                    -79.40301288100547,
                                    43.656286799901146
                                ],
                                [
                                    -79.40294344324236,
                                    43.6563008820903
                                ],
                                [
                                    -79.4029386437327,
                                    43.65630185916254
                                ],
                                [
                                    -79.4028712670558,
                                    43.65613711320872
                                ],
                                [
                                    -79.40284401600813,
                                    43.65606073158525
                                ],
                                [
                                    -79.40268459219428,
                                    43.65609240675634
                                ],
                                [
                                    -79.40286848975248,
                                    43.656552586218766
                                ]
                            ]
                        ]
                    ]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "_id": 58,
                    "GEN_ZONE": 202,
                    "ZN_ZONE": "CR",
                    "ZN_HOLDING": "N",
                    "HOLDING_ID": 0,
                    "FRONTAGE": -1,
                    "ZN_AREA": -1,
                    "UNITS": -1,
                    "DENSITY": -1,
                    "COVERAGE": 0,
                    "FSI_TOTAL": 4,
                    "PRCNT_COMM": 0.5,
                    "PRCNT_RES": 4,
                    "PRCNT_EMMP": 0,
                    "PRCNT_OFFC": -1,
                    "ZN_EXCPTN": "Y",
                    "EXCPTN_NO": 1390,
                    "STAND_SET": 1,
                    "ZN_STATUS": 2,
                    "ZN_STRING": "CR 4.0 (c0.5; r4.0) SS1  (x1390)",
                    "AREA_UNITS": -1,
                    "ZBL_CHAPT": "40",
                    "ZBL_SECTN": "40.10",
                    "ZBL_EXCPTN": "900.11.10(1390)"
                },
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": [
                        [
                            [
                                [
                                    -79.37627166130486,
                                    43.6594864734279
                                ],
                                [
                                    -79.37635177389564,
                                    43.65967669553657
                                ],
                                [
                                    -79.37667501214558,
                                    43.6596049979419
                                ],
                                [
                                    -79.37680039280804,
                                    43.6595770399374
                                ],
                                [
                                    -79.37672337891232,
                                    43.65938663245312
                                ],
                                [
                                    -79.3765965731842,
                                    43.659414399807446
                                ],
                                [
                                    -79.37627166130486,
                                    43.6594864734279
                                ]
                            ]
                        ]
                    ]
                }
            }
        ]
    }

    //var width = 1000;
   // var height = 800;


    var svg = d3.select("#svg1")
    var svg2 = d3.select("#svg2")
        //movable graph
       // .call(d3.behavior.zoom().scaleExtent([1, 10]))

       // .append("g")

    var width = +svg.node().getBoundingClientRect().width
    var  height = +svg.node().getBoundingClientRect().height;

    var datapoints;

    fetch("/file")
        .then(response => response.json())
        .then(jsonData => {
            console.log("Printing fetched jsonFile here:", jsonData)
            //displaydatapoints(jsonData);
            datapoints=jsonData
            okay(datapoints)
        })
        .catch(error => {
            console.log('Error fetching data:', error);
        });


    function okay(datapoints) {
        var filteredadd=[]
        datapoints.addresses.forEach(function(m){
            filteredadd.push({features:m.features})
        })
        d3.json("/crzonesfile")
            .then(function (data1) {
                var projection = d3.geoIdentity().fitSize([width, height], data)
                var path = d3.geoPath(projection);

                svg.selectAll("path")
                    .data(data1.features)
                    .enter()
                    .append("path")
                    .style("border", "solid")
                    .style("border-color", "purple")
                    .style("border-width", "2px")
                    .style("fill", "steelblue")
                    .style("stroke", "steelblue")
                    .style("padding", "10px")
                   // .on("mousemove", mouseover)
                    .call(d3.zoom().on("zoom", function () {
                        svg.attr("transform", d3.event.transform)
                    }))
                    .attr("d", path);

                var tooltip = d3.select("#tooltip")
                    .style("opacity", 1)
                    .attr("class", "tooltip")
                    .style("font-size", "5px");

               //or plot it separately
                svg2.append("svg:defs").append("svg:marker")
                    .attr("id", "triangle")
                    .attr("refX", 13)
                    .attr("refY", 5)
                    .attr("markerWidth", 70)
                    .attr("markerHeight", 70)
                    .attr("markerUnits","userSpaceOnUse")
                    .attr("orient", "auto")
                   // .append("path")
                    .attr("d","M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6" )
                    .style("fill", "red");

                /*svg2.append("marker")
                    .attr({
                        "id": "arrow",
                        "viewBox": "0 -5 10 10",
                        "refX": 5,
                        "refY": 0,
                        "markerWidth": 4,
                        "markerHeight": 4,
                        "orient": "auto"
                    })
                    .append("path")
                    .attr("d", "M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6");*/

                    //.attr("class", "arrowHead");
                var points =svg.selectAll("path")
                    .data(data1.features)
                    .enter()
                    .append("path")
                    .style("border", "solid")
                    .style("border-color", "purple")
                    .style("border-width", "2px")
                    .style("fill", "red")
                    .attr("marker-end", "url(#arrow)")
                    //.attr("d", path);
                    //.style("stroke", "steelblue")
                    //.style("padding", "10px")
                    // .style("transform","scale(100.0)")
                    //.on("mousemove", mouseover)
                   .attr("d",function(d){
                           return "M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"
                    })
               // var marker =svg2.selectAll("marker")









               /* function mouseover(d) {

                    //goals :
                    //zoom out the drawn polygon
                    //put a tooltip on points found within the polygon

                    //so tired
                    //d3.select(this)
                    //    .call(d3.behavior.zoom().scaleExtent([1, 10])
                    //       .on("zoom", zoom));
                    //d3.select(this).attr("transform", "translate(1)scale(10)");
                    //console.log(d)
                    // console.log("mousemove called"+d.geometry.coordinates) //get coords for looping in case of need

                    //check if its in polygon
                    datapoints.addresses.forEach(function (m) {
                        // m.features.forEach(function(k){
                        if (d.properties.ZN_STRING === m.ZN_STRING) {
                            tooltip
                                //.html(d.properties.name)
                                .style("opacity", 1)
                                .style("left", (m.features.geometry.coordinates[0][0]) + "px")
                                .style("top", (m.features.geometry.coordinates[0][1]) + "px");
                                //.style("left", (d3.mouse(this)[0] + 3) + "px")
                               // .style("top", (d3.mouse(this)[1]) + "px");
                           // console.log("true")
                           // m.features..forEach(function(k){
                               //console.log("x:" ,m.features.geometry.coordinates[0][0])
                           // })

                        }
                        // for(var i=0 ; i>d.geometry.coordinates.length;i++){
                        //var b =arraycompare(d.geometry.coordinates[i],k.geometry.coordinates[0])
                        // if( d3.polygonContains(k.geometry.coordinates,d.geometry.coordinates[i] ) ===true){
                        //   console.log("true")
                        // } ******failed

                        // }
                        //loop through d goemetry coords
                        //loop through k coords
                        //if k coord == d coords ... assign tooltip

                       // })
                    })
                    /*tooltip
                        //.html(d.properties.name)
                        .style("opacity", 1)
                        .style("left", (d3.mouse(this)[0] + 3) + "px")
                        .style("top", (d3.mouse(this)[1]) + "px");*/
                    //add location tooltip
               // }*/

                function zoom(d) {
                    d3.select(this).attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
                }

                function arraycompare(array1, array2) {
                    const array2Sorted = array2.slice().sort();
                    array1.length === array2.length && array1.slice().sort().every(function (value, index) {
                        return value === array2Sorted[index];
                    });
                }
            })
            .catch(function (error) {
                // Error occurred while loading the data
                console.error(error);
            });
    }
</script>
</body>
</html>